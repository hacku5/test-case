#!/bin/bash

# ===========================================
# Laravel Docker Development CLI
# Usage: ./dev <command> [arguments]
# ===========================================

# Renklendirme
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Docker Compose komutu
# Docker Compose komutunu belirle
if docker compose version >/dev/null 2>&1; then
    COMPOSE="docker compose"
elif docker.exe compose version >/dev/null 2>&1; then
    COMPOSE="docker.exe compose"
else
    echo "Docker bulunamadı! Lütfen Docker Desktop'ı kurun."
    exit 1
fi

# Yardım mesajı
show_help() {
    echo -e "${GREEN}Laravel Docker Development CLI${NC}"
    echo ""
    echo -e "${YELLOW}Usage:${NC}"
    echo "  ./dev <command> [arguments]"
    echo ""
    echo -e "${YELLOW}Available Commands:${NC}"
    echo -e "  ${BLUE}up${NC}              Start all containers"
    echo -e "  ${BLUE}down${NC}            Stop all containers"
    echo -e "  ${BLUE}restart${NC}         Restart all containers"
    echo -e "  ${BLUE}build${NC}           Rebuild containers"
    echo -e "  ${BLUE}ps${NC}              Show running containers"
    echo -e "  ${BLUE}logs${NC}            Show container logs"
    echo ""
    echo -e "${YELLOW}Artisan Commands:${NC}"
    echo -e "  ${BLUE}artisan${NC}         Run artisan command"
    echo -e "  ${BLUE}migrate${NC}         Run migrations"
    echo -e "  ${BLUE}fresh${NC}           Fresh migration with seed"
    echo -e "  ${BLUE}seed${NC}            Run seeders"
    echo -e "  ${BLUE}tinker${NC}          Start Tinker REPL"
    echo ""
    echo -e "${YELLOW}Testing:${NC}"
    echo -e "  ${BLUE}test${NC}            Run tests"
    echo -e "  ${BLUE}pest${NC}            Run Pest tests"
    echo ""
    echo -e "${YELLOW}Composer:${NC}"
    echo -e "  ${BLUE}composer${NC}        Run composer command"
    echo ""
    echo -e "${YELLOW}Shell:${NC}"
    echo -e "  ${BLUE}shell${NC}           Open shell in app container"
    echo -e "  ${BLUE}bash${NC}            Open bash in app container"
    echo ""
    echo -e "${YELLOW}Database:${NC}"
    echo -e "  ${BLUE}psql${NC}            Open PostgreSQL CLI"
    echo -e "  ${BLUE}redis${NC}           Open Redis CLI"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  ./dev up"
    echo "  ./dev artisan make:model Post -m"
    echo "  ./dev composer require laravel/sanctum"
    echo "  ./dev test --filter=OrderTest"
}

# Container çalışıyor mu kontrol et
is_running() {
    $COMPOSE ps -q app 2>/dev/null | grep -q .
}

# Komut çalıştır
case "$1" in
    # Docker Compose komutları
    up)
        echo -e "${GREEN}Starting containers...${NC}"
        $COMPOSE up -d "${@:2}"
        ;;
    down)
        echo -e "${YELLOW}Stopping containers...${NC}"
        $COMPOSE down "${@:2}"
        ;;
    restart)
        echo -e "${YELLOW}Restarting containers...${NC}"
        $COMPOSE restart "${@:2}"
        ;;
    build)
        echo -e "${BLUE}Building containers...${NC}"
        $COMPOSE up -d --build "${@:2}"
        ;;
    ps)
        $COMPOSE ps "${@:2}"
        ;;
    logs)
        $COMPOSE logs -f "${@:2}"
        ;;

    # Artisan komutları
    artisan|art)
        $COMPOSE exec app php artisan "${@:2}"
        ;;
    migrate)
        $COMPOSE exec app php artisan migrate "${@:2}"
        ;;
    fresh)
        $COMPOSE exec app php artisan migrate:fresh --seed "${@:2}"
        ;;
    seed)
        $COMPOSE exec app php artisan db:seed "${@:2}"
        ;;
    tinker)
        $COMPOSE exec app php artisan tinker
        ;;

    # Test komutları
    test)
        $COMPOSE exec app php artisan test "${@:2}"
        ;;
    pest)
        $COMPOSE exec app ./vendor/bin/pest "${@:2}"
        ;;

    # NPM
    npm)
        $COMPOSE exec app npm "${@:2}"
        ;;

    # Composer
    composer)
        $COMPOSE exec app composer "${@:2}"
        ;;

    # Shell erişimi
    shell|sh)
        $COMPOSE exec app sh
        ;;
    bash)
        $COMPOSE exec app bash 2>/dev/null || $COMPOSE exec app sh
        ;;

    # Veritabanı
    psql)
        $COMPOSE exec db psql -U "${DB_USERNAME:-laravel}" -d "${DB_DATABASE:-laravel}"
        ;;
    redis)
        $COMPOSE exec redis redis-cli
        ;;

    # Yardım
    help|-h|--help|"")
        show_help
        ;;

    # Bilinmeyen komut - docker compose'a geçir
    *)
        $COMPOSE "$@"
        ;;
esac
